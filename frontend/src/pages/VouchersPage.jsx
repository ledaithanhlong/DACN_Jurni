import React, { useEffect, useState } from 'react';
import axios from 'axios';
import { useAuth } from '@clerk/clerk-react';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

const API = import.meta.env.VITE_API_URL || 'http://localhost:5000/api';

// Generate QR Code URL using a free QR code API
const generateQRCode = (text) => {
  return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(text)}`;
};

// Mock data ƒë·ªÉ test
const mockVoucherData = {
  booking_code: 'JRN-2025-001',
  booking_date: '2025-01-15',
  status: 'ƒê√£ thanh to√°n',
  payment_method: 'VNPay',
  customer: {
    name: 'L√™ ƒê·∫°i Thanh Long',
    phone: '0769 749 465',
    email: 'lucaslee050304@gmail.com'
  },
  services: [
    {
      type: 'flight',
      name: 'Vietnam Airlines VN123',
      description: 'H·ªì Ch√≠ Minh ‚Äì H√† N·ªôi',
      start_date: '2025-01-20',
      end_date: '2025-01-20',
      price: 5000000
    },
    {
      type: 'hotel',
      name: 'Grand Hotel Hanoi',
      description: 'Ph√≤ng Deluxe, 2 ƒë√™m',
      start_date: '2025-01-20',
      end_date: '2025-01-22',
      price: 6000000
    },
    {
      type: 'car',
      name: 'Toyota Vios',
      description: '5 ch·ªó, 3 ng√†y',
      start_date: '2025-01-20',
      end_date: '2025-01-23',
      price: 2400000
    },
    {
      type: 'activity',
      name: 'Tour Ph·ªë C·ªï H√† N·ªôi',
      description: '4 gi·ªù, 2 ng∆∞·ªùi',
      start_date: '2025-01-21',
      end_date: '2025-01-21',
      price: 1600000
    }
  ],
  total_price: 15000000
};

// Icon Components
const IconPlane = () => (
  <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
  </svg>
);

const IconHotel = () => (
  <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
  </svg>
);

const IconCar = () => (
  <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
  </svg>
);

const IconActivity = () => (
  <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
  </svg>
);

const IconCheck = () => (
  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" strokeWidth={2.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" />
  </svg>
);

const IconDownload = () => (
  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
  </svg>
);

const IconPrint = () => (
  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 19.5l-1.591-1.591a2.25 2.25 0 010-3.182L8.25 13.5H4.5A2.25 2.25 0 002.25 15.75v3.75A2.25 2.25 0 006.75 22.5h3.75a2.25 2.25 0 002.25-2.25V18l-1.591 1.591a2.25 2.25 0 01-3.182 0zM19.5 6.75l-1.591 1.591a2.25 2.25 0 01-3.182 0L13.5 8.25v-3.75A2.25 2.25 0 0115.75 2.25h3.75A2.25 2.25 0 0121.75 4.5v3.75a2.25 2.25 0 01-2.25 2.25h-3.75l-1.591-1.591a2.25 2.25 0 010-3.182L19.5 6.75z" />
  </svg>
);

// Helper functions
const formatPrice = (price) => {
  return new Intl.NumberFormat('vi-VN').format(price || 0);
};

const formatDate = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('vi-VN', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
};

const getServiceIcon = (type) => {
  switch (type) {
    case 'flight':
      return <IconPlane />;
    case 'hotel':
      return <IconHotel />;
    case 'car':
      return <IconCar />;
    case 'activity':
      return <IconActivity />;
    default:
      return <IconActivity />;
  }
};

const getServiceEmoji = (type) => {
  switch (type) {
    case 'flight':
      return '‚úàÔ∏è';
    case 'hotel':
      return 'üè®';
    case 'car':
      return 'üöó';
    case 'activity':
      return 'üé´';
    default:
      return 'üé´';
  }
};

const getServiceName = (type) => {
  switch (type) {
    case 'flight':
      return 'V√© m√°y bay';
    case 'hotel':
      return 'Kh√°ch s·∫°n';
    case 'car':
      return 'Thu√™ xe';
    case 'activity':
      return 'Tour & ho·∫°t ƒë·ªông';
    default:
      return 'D·ªãch v·ª•';
  }
};

export default function VouchersPage() {
  const [vouchers, setVouchers] = useState([mockVoucherData]);
  const [loading, setLoading] = useState(false);
  const { getToken, isSignedIn } = useAuth();

  useEffect(() => {
    const loadVouchers = async () => {
      if (!isSignedIn) {
        setVouchers([mockVoucherData]);
        return;
      }

      try {
        setLoading(true);
        const token = await getToken();
        const res = await axios.get(`${API}/bookings`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        // Transform bookings to vouchers format
        const transformedVouchers = res.data.map(booking => ({
          booking_code: booking.booking_code || `JRN-${booking.id}`,
          booking_date: booking.created_at,
          status: booking.status || 'ƒê√£ thanh to√°n',
          payment_method: booking.payment_method || 'VNPay',
          customer: {
            name: booking.customer_name || 'Kh√°ch h√†ng',
            phone: booking.customer_phone || '',
            email: booking.customer_email || ''
          },
          services: booking.services || [],
          total_price: booking.total_price || 0
        }));

        setVouchers(transformedVouchers.length > 0 ? transformedVouchers : [mockVoucherData]);
      } catch (error) {
        console.error('Error loading vouchers:', error);
        setVouchers([mockVoucherData]);
      } finally {
        setLoading(false);
      }
    };

    loadVouchers();
  }, [isSignedIn, getToken]);

  const handlePrint = (voucher) => {
    const printWindow = window.open('', '_blank');
    const qrCodeUrl = generateQRCode(voucher.booking_code);
    const bookingCode = voucher.booking_code.replace(/[^a-zA-Z0-9-]/g, '_');
    const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
    const fileName = `Voucher-${bookingCode}-${timestamp}`;

    printWindow.document.write(`
      <!DOCTYPE html>
      <html lang="vi">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${fileName}</title>
        <link rel="icon" type="image/png" href="/JurniLogo/favicon-96x96.png" sizes="96x96" />
        <style>
          @page {
            size: A4;
            margin: 8mm;
          }
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: white;
            padding: 0;
            color: #1f2937;
            font-size: 11px;
            line-height: 1.4;
          }
          .voucher-container {
            width: 100%;
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 12px;
            position: relative;
          }
          .seal-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.05;
            pointer-events: none;
            z-index: 0;
            background-image: url('/JurniLogo/jurni-seal.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 400px 400px;
          }
          .voucher-content-wrapper {
            position: relative;
            z-index: 1;
          }
          .voucher-header {
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 12px;
          }
          .voucher-header h1 {
            font-size: 24px;
            font-weight: 900;
            color: #0A4EC3;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
          }
          .voucher-header .subtitle {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
          }
          .header-logo {
            width: 48px;
            height: 48px;
            margin: 0 auto 8px;
            object-fit: contain;
          }
          .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
          }
          .info-box {
            background: #f8fafc;
            border: 2px solid #0A4EC3;
            border-radius: 8px;
            padding: 10px;
          }
          .info-box h3 {
            font-size: 9px;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
          }
          .info-item {
            margin-bottom: 6px;
            font-size: 10px;
          }
          .info-label {
            color: #64748b;
            font-size: 8px;
            margin-bottom: 2px;
          }
          .info-value {
            color: #0A4EC3;
            font-weight: 700;
            font-size: 11px;
          }
          .qr-section {
            text-align: center;
          }
          .qr-code {
            width: 90px;
            height: 90px;
            margin: 8px auto;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px;
            background: white;
          }
          .qr-code img {
            width: 100%;
            height: 100%;
            object-fit: contain;
          }
          .qr-note {
            font-size: 9px;
            color: #64748b;
            font-style: italic;
            margin-top: 8px;
          }
          .services-section {
            margin-bottom: 12px;
          }
          .section-title {
            font-size: 13px;
            font-weight: 800;
            color: #0A4EC3;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #0A4EC3;
            text-transform: uppercase;
          }
          .service-item {
            background: white;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
          }
          .service-icon {
            width: 36px;
            height: 36px;
            background: #eff6ff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
          }
          .service-content {
            flex: 1;
          }
          .service-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
          }
          .service-name {
            font-size: 12px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 3px;
            line-height: 1.3;
          }
          .service-description {
            font-size: 10px;
            color: #64748b;
            margin-bottom: 4px;
            line-height: 1.3;
          }
          .service-date {
            font-size: 9px;
            color: #94a3b8;
          }
          .service-price {
            font-size: 13px;
            font-weight: 800;
            color: #0A4EC3;
            text-align: right;
          }
          .total-section {
            background: linear-gradient(135deg, #0A4EC3 0%, #2563eb 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 12px;
          }
          .total-label {
            font-size: 9px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
          }
          .total-amount {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 8px;
          }
          .payment-info {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 12px;
          }
          .payment-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
          }
          .instructions-section {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
          }
          .instructions-title {
            font-size: 10px;
            font-weight: 800;
            color: #92400e;
            margin-bottom: 8px;
            text-transform: uppercase;
          }
          .instructions-list {
            list-style: none;
          }
          .instructions-list li {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 5px;
            font-size: 9px;
            color: #78350f;
            line-height: 1.3;
          }
          .instructions-list li::before {
            content: '‚úì';
            color: #10b981;
            font-weight: 800;
            font-size: 11px;
            flex-shrink: 0;
            background: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .seal-section {
            text-align: center;
            margin-bottom: 10px;
            padding: 8px;
          }
          .seal-placeholder {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            border: 2px dashed #cbd5e1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(10, 78, 195, 0.05);
            opacity: 0.3;
          }
          .seal-note {
            font-size: 8px;
            color: #94a3b8;
            margin-top: 6px;
            font-style: italic;
          }
          .footer {
            text-align: center;
            padding-top: 10px;
            border-top: 2px solid #e5e7eb;
            color: #64748b;
            font-size: 9px;
          }
          .footer-logo {
            font-size: 16px;
            font-weight: 900;
            color: #0A4EC3;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
          }
          .footer div {
            margin: 4px 0;
            line-height: 1.5;
          }
          @media print {
            body {
              background: white;
            }
            .voucher-container {
              max-width: 100%;
              padding: 0;
            }
            .service-item {
              page-break-inside: avoid;
            }
          }
        </style>
      </head>
      <body>
        <div class="voucher-container">
          <div class="seal-background"></div>
          <div class="voucher-content-wrapper">
          <div class="voucher-header">
            <img src="/JurniLogo/apple-touch-icon.png" alt="Jurni Logo" class="header-logo" />
            <h1>TRAVEL VOUCHER</h1>
            <div class="subtitle">X√°c nh·∫≠n d·ªãch v·ª• ƒë√£ thanh to√°n</div>
          </div>

          <div class="info-grid">
            <div class="info-box">
              <h3>Th√¥ng tin ƒë·∫∑t tour</h3>
              <div class="info-item">
                <div class="info-label">M√£ ƒë·∫∑t tour</div>
                <div class="info-value">${voucher.booking_code}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Ng√†y ƒë·∫∑t</div>
                <div class="info-value">${formatDate(voucher.booking_date)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Tr·∫°ng th√°i</div>
                <div class="info-value">${voucher.status}</div>
              </div>
            </div>

            <div class="info-box">
              <h3>Th√¥ng tin kh√°ch h√†ng</h3>
              <div class="info-item">
                <div class="info-label">H·ªç t√™n</div>
                <div class="info-value">${voucher.customer?.name || 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">S·ªë ƒëi·ªán tho·∫°i</div>
                <div class="info-value">${voucher.customer?.phone || 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${voucher.customer?.email || 'N/A'}</div>
              </div>
            </div>

            <div class="info-box">
              <h3>QR Code</h3>
              <div class="qr-section">
                <div class="qr-code">
                  <img src="${qrCodeUrl}" alt="QR Code" />
                </div>
                <div class="qr-note">Qu√©t m√£ ƒë·ªÉ ki·ªÉm tra t√¨nh tr·∫°ng thanh to√°n</div>
              </div>
            </div>
          </div>

          <div class="services-section" style="position: relative; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
              <div class="section-title" style="font-size: 15px; font-weight: 800; color: #0A4EC3; margin-bottom: 0; padding-bottom: 6px; border-bottom: 2px solid #0A4EC3; text-transform: uppercase;">Chi ti·∫øt d·ªãch v·ª•</div>
              <!-- T·ªïng ti·ªÅn ·ªü g√≥c ph·∫£i -->
              <div style="background: linear-gradient(to right, #10b981, #059669); color: white; padding: 12px; border-radius: 8px; border: 2px solid #34d399; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 180px;">
                <div style="font-size: 10px; text-transform: uppercase; opacity: 0.95; margin-bottom: 6px; letter-spacing: 0.5px; font-weight: 700; text-align: center;">T·ªïng ti·ªÅn thanh to√°n</div>
                <div style="font-size: 20px; font-weight: 900; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center;">${formatPrice(voucher.total_price)} VND</div>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                  <div style="background: rgba(255, 255, 255, 0.3); padding: 4px 8px; border-radius: 9999px; font-size: 10px; font-weight: 700; border: 2px solid rgba(255,255,255,0.5); text-align: center;">‚úì ƒê√£ thanh to√°n</div>
                  <div style="background: rgba(255, 255, 255, 0.3); padding: 4px 8px; border-radius: 9999px; font-size: 10px; font-weight: 700; border: 2px solid rgba(255,255,255,0.5); text-align: center;">${voucher.payment_method || 'VNPay'}</div>
                </div>
              </div>
            </div>
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db; font-size: 11px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <thead>
                <tr style="background: linear-gradient(to right, #0A4EC3, #2563eb); color: white;">
                  <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Lo·∫°i d·ªãch v·ª•</th>
                  <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">T√™n d·ªãch v·ª•</th>
                  <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">M√¥ t·∫£</th>
                  <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Th·ªùi gian</th>
                  <th style="text-align: right; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody>
                ${voucher.services?.map((service, idx) => `
                  <tr style="border-bottom: 1px solid #e5e7eb; background: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                    <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.3px;">${getServiceName(service.type)}</div>
                    </td>
                    <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                      <div style="font-size: 15px; font-weight: 700; color: #111827;">${service.name}</div>
                    </td>
                    <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                      <div style="font-size: 13px; color: #4b5563; line-height: 1.5;">${service.description || '-'}</div>
                    </td>
                    <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                      <div style="font-size: 13px; color: #374151; white-space: nowrap;">
                        <div style="font-weight: 500;">${formatDate(service.start_date)}</div>
                        <div style="color: #6b7280;">ƒë·∫øn ${formatDate(service.end_date)}</div>
                      </div>
                    </td>
                    <td style="padding: 12px 20px; text-align: right;">
                      <div style="font-size: 15px; font-weight: 900; color: #0A4EC3; white-space: nowrap;">
                        ${formatPrice(service.price)} VND
                      </div>
                    </td>
                  </tr>
                `).join('') || ''}
              </tbody>
            </table>
          </div>

          <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 12px; align-items: stretch;">
            <!-- PH·∫¶N H∆Ø·ªöNG D·∫™N -->
            <div class="instructions-section" 
                style="background: #fffef5; border-left: 4px solid #fbbf24; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div class="instructions-title" 
                  style="font-size: 14px; font-weight: 900; margin-bottom: 16px; color: #78350f; text-transform: uppercase; letter-spacing: 0.5px;">
                H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG VOUCHER
              </div>
              <ul class="instructions-list" style="list-style: none; padding: 0; margin: 0; line-height: 1.8;">
                <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                  <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                  <span>Check-in s√¢n bay b·∫±ng QR ho·∫∑c m√£ tour</span>
                </li>
                <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                  <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                  <span>Nh·∫≠n ph√≤ng c·∫ßn voucher + CCCD</span>
                </li>
                <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                  <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                  <span>Nh·∫≠n xe c·∫ßn ƒë·ªëi chi·∫øu th√¥ng tin</span>
                </li>
                <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                  <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                  <span>Tham gia tour tr√¨nh voucher cho HDV</span>
                </li>
              </ul>
            </div>

            <!-- D·∫§U M·ªòC -->
            <div style="
                  display: flex; 
                  flex-direction: column; 
                  align-items: center; 
                  justify-content: center;
                  height: 100%;
                ">
              <div style="
                    width: 144px;
                    height: 144px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  ">
                <img src="/JurniLogo/jurni-seal.png" 
                    alt="Jurni Seal"
                    style="
                      width: 100%;
                      height: 100%;
                      object-fit: contain;
                    "
                    onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px;\'><div style=\'font-size: 8px; font-weight: 700; color: #0A4EC3; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;\'>VERIFIED & APPROVED</div><div style=\'font-size: 24px; font-weight: 900; color: #0A4EC3; margin-bottom: 4px;\'>JURNI</div><div style=\'font-size: 7px; font-weight: 600; color: #0A4EC3; margin-bottom: 4px;\'>TRAVEL</div><div style=\'font-size: 6px; font-weight: 500; color: #0A4EC3;\'>EST. 2025</div><div style=\'font-size: 6px; font-weight: 700; color: #0A4EC3; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 4px;\'>OFFICIAL AUTHENTICATION SEAL</div></div>';" />
              </div>

              <div style="margin-top: 8px; font-size: 12px; color: #78350f; font-style: italic;">
                Ch·ª©ng nh·∫≠n b·ªüi JURNI
              </div>
            </div>
          </div>


          <div class="footer">
            <div class="footer-logo">JURNI TRAVEL</div>
            <div>Ph√¢n khu E1, Khu c√¥ng ngh·ªá cao, Xa l·ªô H√† N·ªôi, Ph∆∞·ªùng Hi·ªáp Ph√∫, TP. Th·ªß ƒê·ª©c, TP.HCM</div>
            <div>Hotline: 0769 749 465 | Email: support@jurni.com</div>
            <div style="margin-top: 12px; font-size: 9px; color: #94a3b8;">
              Voucher n√†y l√† t√†i li·ªáu ch√≠nh th·ª©c x√°c nh·∫≠n vi·ªác ƒë·∫∑t v√† thanh to√°n d·ªãch v·ª• du l·ªãch.
            </div>
          </div>
          </div>
        </div>
      </body>
      </html>
    `);
    printWindow.document.close();
    
    setTimeout(() => {
      printWindow.document.title = fileName;
      printWindow.print();
    }, 500);
  };

  const handleDownload = async (voucher) => {
    try {
      const iframe = document.createElement('iframe');
      iframe.style.position = 'fixed';
      iframe.style.right = '0';
      iframe.style.bottom = '0';
      iframe.style.width = '0';
      iframe.style.height = '0';
      iframe.style.border = 'none';
      iframe.style.opacity = '0';
      iframe.style.pointerEvents = 'none';
      document.body.appendChild(iframe);
      
      const qrCodeUrl = generateQRCode(voucher.booking_code);
      
      iframe.contentDocument.open();
      iframe.contentDocument.write(`
        <!DOCTYPE html>
        <html lang="vi">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Travel Voucher - ${voucher.booking_code}</title>
          <link rel="icon" type="image/png" href="/JurniLogo/favicon-96x96.png" sizes="96x96" />
          <style>
            @page {
              size: A4;
              margin: 8mm;
            }
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
              background: white;
              padding: 0;
              color: #1f2937;
              font-size: 11px;
              line-height: 1.4;
            }
            .voucher-container {
              width: 100%;
              max-width: 210mm;
              margin: 0 auto;
              background: white;
              padding: 12px;
              position: relative;
            }
            .seal-background {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              opacity: 0.05;
              pointer-events: none;
              z-index: 0;
              background-image: url('/JurniLogo/jurni-seal.png');
              background-repeat: no-repeat;
              background-position: center;
              background-size: 400px 400px;
            }
            .voucher-content-wrapper {
              position: relative;
              z-index: 1;
            }
            .voucher-header {
              text-align: center;
              padding-bottom: 12px;
              border-bottom: 2px solid #e5e7eb;
              margin-bottom: 12px;
            }
            .voucher-header h1 {
              font-size: 24px;
              font-weight: 900;
              color: #0A4EC3;
              margin-bottom: 4px;
              text-transform: uppercase;
              letter-spacing: 1.5px;
            }
            .voucher-header .subtitle {
              font-size: 10px;
              color: #64748b;
              font-weight: 500;
            }
            .header-logo {
              width: 48px;
              height: 48px;
              margin: 0 auto 8px;
              object-fit: contain;
            }
            .info-grid {
              display: grid;
              grid-template-columns: 1fr 1fr 1fr;
              gap: 10px;
              margin-bottom: 12px;
            }
            .info-box {
              background: #f8fafc;
              border: 2px solid #0A4EC3;
              border-radius: 8px;
              padding: 10px;
            }
            .info-box h3 {
              font-size: 9px;
              text-transform: uppercase;
              color: #64748b;
              margin-bottom: 8px;
              font-weight: 700;
              letter-spacing: 0.5px;
            }
            .info-item {
              margin-bottom: 6px;
              font-size: 10px;
            }
            .info-label {
              color: #64748b;
              font-size: 8px;
              margin-bottom: 2px;
            }
            .info-value {
              color: #0A4EC3;
              font-weight: 700;
              font-size: 11px;
            }
            .qr-section {
              text-align: center;
            }
            .qr-code {
              width: 90px;
              height: 90px;
              margin: 8px auto;
              border: 2px solid #e5e7eb;
              border-radius: 6px;
              padding: 6px;
              background: white;
            }
            .qr-code img {
              width: 100%;
              height: 100%;
              object-fit: contain;
            }
            .qr-note {
              font-size: 9px;
              color: #64748b;
              font-style: italic;
              margin-top: 8px;
            }
            .services-section {
              margin-bottom: 12px;
            }
            .section-title {
              font-size: 13px;
              font-weight: 800;
              color: #0A4EC3;
              margin-bottom: 10px;
              padding-bottom: 6px;
              border-bottom: 2px solid #0A4EC3;
              text-transform: uppercase;
            }
            .service-item {
              background: white;
              border: 1.5px solid #e5e7eb;
              border-radius: 8px;
              padding: 10px;
              margin-bottom: 8px;
              display: flex;
              align-items: flex-start;
              gap: 10px;
            }
            .service-icon {
              width: 36px;
              height: 36px;
              background: #eff6ff;
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              font-size: 18px;
            }
            .service-content {
              flex: 1;
            }
            .service-header {
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: 8px;
            }
            .service-name {
              font-size: 12px;
              font-weight: 700;
              color: #1f2937;
              margin-bottom: 3px;
              line-height: 1.3;
            }
            .service-description {
              font-size: 10px;
              color: #64748b;
              margin-bottom: 4px;
              line-height: 1.3;
            }
            .service-date {
              font-size: 9px;
              color: #94a3b8;
            }
            .service-price {
              font-size: 13px;
              font-weight: 800;
              color: #0A4EC3;
              text-align: right;
            }
            .total-section {
              background: linear-gradient(135deg, #0A4EC3 0%, #2563eb 100%);
              color: white;
              padding: 12px;
              border-radius: 8px;
              text-align: center;
              margin-bottom: 12px;
            }
            .total-label {
              font-size: 9px;
              text-transform: uppercase;
              opacity: 0.9;
              margin-bottom: 6px;
              letter-spacing: 0.5px;
            }
            .total-amount {
              font-size: 24px;
              font-weight: 900;
              margin-bottom: 8px;
            }
            .payment-info {
              display: flex;
              justify-content: center;
              gap: 16px;
              flex-wrap: wrap;
              margin-top: 12px;
            }
            .payment-badge {
              background: rgba(255, 255, 255, 0.2);
              padding: 6px 12px;
              border-radius: 20px;
              font-size: 10px;
              font-weight: 600;
            }
            .instructions-section {
              background: #fef3c7;
              border-left: 3px solid #f59e0b;
              padding: 10px;
              border-radius: 8px;
              margin-bottom: 10px;
            }
            .instructions-title {
              font-size: 10px;
              font-weight: 800;
              color: #92400e;
              margin-bottom: 8px;
              text-transform: uppercase;
            }
            .instructions-list {
              list-style: none;
            }
            .instructions-list li {
              display: flex;
              align-items: flex-start;
              gap: 6px;
              margin-bottom: 5px;
              font-size: 9px;
              color: #78350f;
              line-height: 1.3;
            }
            .instructions-list li::before {
              content: '‚úì';
              color: #10b981;
              font-weight: 800;
              font-size: 11px;
              flex-shrink: 0;
              background: white;
              width: 16px;
              height: 16px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .seal-section {
              text-align: center;
              margin-bottom: 10px;
              padding: 8px;
            }
            .seal-placeholder {
              width: 80px;
              height: 80px;
              margin: 0 auto;
              border: 2px dashed #cbd5e1;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              background: rgba(10, 78, 195, 0.05);
              opacity: 0.3;
            }
            .seal-note {
              font-size: 8px;
              color: #94a3b8;
              margin-top: 6px;
              font-style: italic;
            }
            .footer {
              text-align: center;
              padding-top: 10px;
              border-top: 2px solid #e5e7eb;
              color: #64748b;
              font-size: 9px;
            }
            .footer-logo {
              font-size: 16px;
              font-weight: 900;
              color: #0A4EC3;
              margin-bottom: 8px;
              text-transform: uppercase;
              letter-spacing: 1px;
            }
            .footer div {
              margin: 4px 0;
              line-height: 1.5;
            }
          </style>
        </head>
        <body>
          <div class="voucher-container" id="voucher-content">
            <div class="seal-background"></div>
            <div class="voucher-content-wrapper">
            <div class="voucher-header">
              <img src="/JurniLogo/apple-touch-icon.png" alt="Jurni Logo" class="header-logo" />
              <h1>TRAVEL VOUCHER</h1>
              <div class="subtitle">X√°c nh·∫≠n d·ªãch v·ª• ƒë√£ thanh to√°n</div>
            </div>

            <div class="info-grid">
              <div class="info-box">
                <h3>Th√¥ng tin ƒë·∫∑t tour</h3>
                <div class="info-item">
                  <div class="info-label">M√£ ƒë·∫∑t tour</div>
                  <div class="info-value">${voucher.booking_code}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Ng√†y ƒë·∫∑t</div>
                  <div class="info-value">${formatDate(voucher.booking_date)}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Tr·∫°ng th√°i</div>
                  <div class="info-value">${voucher.status}</div>
                </div>
              </div>

              <div class="info-box">
                <h3>Th√¥ng tin kh√°ch h√†ng</h3>
                <div class="info-item">
                  <div class="info-label">H·ªç t√™n</div>
                  <div class="info-value">${voucher.customer?.name || 'N/A'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">S·ªë ƒëi·ªán tho·∫°i</div>
                  <div class="info-value">${voucher.customer?.phone || 'N/A'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Email</div>
                  <div class="info-value">${voucher.customer?.email || 'N/A'}</div>
                </div>
              </div>

              <div class="info-box">
                <h3>QR Code</h3>
                <div class="qr-section">
                  <div class="qr-code">
                    <img src="${qrCodeUrl}" alt="QR Code" />
                  </div>
                  <div class="qr-note">Qu√©t m√£ ƒë·ªÉ ki·ªÉm tra t√¨nh tr·∫°ng thanh to√°n</div>
                </div>
              </div>
            </div>

            <div class="services-section" style="position: relative; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div class="section-title" style="font-size: 15px; font-weight: 800; color: #0A4EC3; margin-bottom: 0; padding-bottom: 6px; border-bottom: 2px solid #0A4EC3; text-transform: uppercase;">Chi ti·∫øt d·ªãch v·ª•</div>
                <!-- T·ªïng ti·ªÅn ·ªü g√≥c ph·∫£i -->
                <div style="background: linear-gradient(to right, #10b981, #059669); color: white; padding: 12px; border-radius: 8px; border: 2px solid #34d399; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 180px;">
                  <div style="font-size: 10px; text-transform: uppercase; opacity: 0.95; margin-bottom: 6px; letter-spacing: 0.5px; font-weight: 700; text-align: center;">T·ªïng ti·ªÅn thanh to√°n</div>
                  <div style="font-size: 20px; font-weight: 900; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center;">${formatPrice(voucher.total_price)} VND</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: rgba(255, 255, 255, 0.3); padding: 4px 8px; border-radius: 9999px; font-size: 10px; font-weight: 700; border: 2px solid rgba(255,255,255,0.5); text-align: center;">‚úì ƒê√£ thanh to√°n</div>
                    <div style="background: rgba(255, 255, 255, 0.3); padding: 4px 8px; border-radius: 9999px; font-size: 10px; font-weight: 700; border: 2px solid rgba(255,255,255,0.5); text-align: center;">${voucher.payment_method || 'VNPay'}</div>
                  </div>
                </div>
              </div>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db; font-size: 11px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <thead>
                  <tr style="background: linear-gradient(to right, #0A4EC3, #2563eb); color: white;">
                    <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Lo·∫°i d·ªãch v·ª•</th>
                    <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">T√™n d·ªãch v·ª•</th>
                    <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">M√¥ t·∫£</th>
                    <th style="text-align: left; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Th·ªùi gian</th>
                    <th style="text-align: right; padding: 14px 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Th√†nh ti·ªÅn</th>
                  </tr>
                </thead>
                <tbody>
                  ${voucher.services?.map((service, idx) => `
                    <tr style="border-bottom: 1px solid #e5e7eb; background: ${idx % 2 === 0 ? '#ffffff' : '#f9fafb'};">
                      <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.3px;">${getServiceName(service.type)}</div>
                      </td>
                      <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                        <div style="font-size: 15px; font-weight: 700; color: #111827;">${service.name}</div>
                      </td>
                      <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #4b5563; line-height: 1.5;">${service.description || '-'}</div>
                      </td>
                      <td style="padding: 12px 20px; border-right: 1px solid #e5e7eb;">
                        <div style="font-size: 13px; color: #374151; white-space: nowrap;">
                          <div style="font-weight: 500;">${formatDate(service.start_date)}</div>
                          <div style="color: #6b7280;">ƒë·∫øn ${formatDate(service.end_date)}</div>
                        </div>
                      </td>
                      <td style="padding: 12px 20px; text-align: right;">
                        <div style="font-size: 15px; font-weight: 900; color: #0A4EC3; white-space: nowrap;">
                          ${formatPrice(service.price)} VND
                        </div>
                      </td>
                    </tr>
                  `).join('') || ''}
                </tbody>
              </table>
            </div>

            <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 12px; align-items: stretch;">
              <!-- PH·∫¶N H∆Ø·ªöNG D·∫™N -->
              <div class="instructions-section" 
                  style="background: #fffef5; border-left: 4px solid #fbbf24; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div class="instructions-title" 
                    style="font-size: 14px; font-weight: 900; margin-bottom: 16px; color: #78350f; text-transform: uppercase; letter-spacing: 0.5px;">
                  H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG VOUCHER
                </div>
                <ul class="instructions-list" style="list-style: none; padding: 0; margin: 0; line-height: 1.8;">
                  <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                    <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                    <span>Check-in s√¢n bay b·∫±ng QR ho·∫∑c m√£ tour</span>
                  </li>
                  <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                    <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                    <span>Nh·∫≠n ph√≤ng c·∫ßn voucher + CCCD</span>
                  </li>
                  <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                    <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                    <span>Nh·∫≠n xe c·∫ßn ƒë·ªëi chi·∫øu th√¥ng tin</span>
                  </li>
                  <li style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #78350f;">
                    <span style="width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #16a34a; font-weight: 700; font-size: 12px;">‚úì</span>
                    <span>Tham gia tour tr√¨nh voucher cho HDV</span>
                  </li>
                </ul>
              </div>

              <!-- D·∫§U M·ªòC -->
              <div style="
                    display: flex; 
                    flex-direction: column; 
                    align-items: center; 
                    justify-content: center;
                    height: 100%;
                  ">
                <div style="
                      width: 144px;
                      height: 144px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    ">
                  <img src="/JurniLogo/jurni-seal.png" 
                      alt="Jurni Seal"
                      style="
                        width: 100%;
                        height: 100%;
                        object-fit: contain;
                      "
                      onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px;\'><div style=\'font-size: 8px; font-weight: 700; color: #0A4EC3; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;\'>VERIFIED & APPROVED</div><div style=\'font-size: 24px; font-weight: 900; color: #0A4EC3; margin-bottom: 4px;\'>JURNI</div><div style=\'font-size: 7px; font-weight: 600; color: #0A4EC3; margin-bottom: 4px;\'>TRAVEL</div><div style=\'font-size: 6px; font-weight: 500; color: #0A4EC3;\'>EST. 2025</div><div style=\'font-size: 6px; font-weight: 700; color: #0A4EC3; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 4px;\'>OFFICIAL AUTHENTICATION SEAL</div></div>';" />
                </div>

                <div style="margin-top: 8px; font-size: 12px; color: #78350f; font-style: italic;">
                  Ch·ª©ng nh·∫≠n b·ªüi JURNI
                </div>
              </div>
            </div>

            <div class="footer">
              <div class="footer-logo">JURNI TRAVEL</div>
              <div>Ph√¢n khu E1, Khu c√¥ng ngh·ªá cao, Xa l·ªô H√† N·ªôi, Ph∆∞·ªùng Hi·ªáp Ph√∫, TP. Th·ªß ƒê·ª©c, TP.HCM</div>
              <div>Hotline: 0769 749 465 | Email: support@jurni.com</div>
              <div style="margin-top: 12px; font-size: 9px; color: #94a3b8;">
                Voucher n√†y l√† t√†i li·ªáu ch√≠nh th·ª©c x√°c nh·∫≠n vi·ªác ƒë·∫∑t v√† thanh to√°n d·ªãch v·ª• du l·ªãch.
              </div>
            </div>
          </div>
        </body>
        </html>
      `);
      iframe.contentDocument.close();

      await new Promise((resolve) => {
        setTimeout(() => {
          const doc = iframe.contentDocument;
          const images = doc.querySelectorAll('img');
          let loadedImages = 0;
          const totalImages = images.length;

          if (totalImages === 0) {
            resolve();
            return;
          }

          images.forEach((img) => {
            if (img.complete) {
              loadedImages++;
              if (loadedImages === totalImages) resolve();
            } else {
              img.onload = () => {
                loadedImages++;
                if (loadedImages === totalImages) resolve();
              };
              img.onerror = () => {
                loadedImages++;
                if (loadedImages === totalImages) resolve();
              };
            }
          });
        }, 1000);
      });

      const element = iframe.contentDocument.getElementById('voucher-content');
      const canvas = await html2canvas(element, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        width: element.scrollWidth,
        height: element.scrollHeight,
        windowWidth: element.scrollWidth,
        windowHeight: element.scrollHeight
      });

      const bookingCode = voucher.booking_code.replace(/[^a-zA-Z0-9-]/g, '_');
      const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
      const fileName = `Voucher-${bookingCode}-${timestamp}.jpg`;

      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          if (document.body.contains(iframe)) {
            document.body.removeChild(iframe);
          }
        }, 100);
      }, 'image/jpeg', 0.95);
    } catch (error) {
      console.error('Error generating JPG:', error);
      alert('C√≥ l·ªói x·∫£y ra khi t·∫°o file JPG. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#0A4EC3]"></div>
          <p className="mt-4 text-gray-600">ƒêang t·∫£i voucher...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/20 to-white py-12">
      <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* Header */}
        <div className="text-center mb-16">
          <div className="inline-block mb-6">
            <div className="w-20 h-1 bg-gradient-to-r from-transparent via-[#0A4EC3] to-transparent mx-auto mb-4"></div>
            <h1 className="text-5xl md:text-6xl font-extrabold text-gray-900 mb-4 tracking-tight">
              Travel Voucher
            </h1>
            <div className="w-20 h-1 bg-gradient-to-r from-transparent via-[#0A4EC3] to-transparent mx-auto"></div>
          </div>
          <p className="text-lg md:text-xl text-gray-600 font-medium tracking-wide">
            X√°c nh·∫≠n d·ªãch v·ª• ƒë√£ thanh to√°n
          </p>
        </div>

        {/* Vouchers List */}
        {vouchers.length === 0 ? (
          <div className="text-center py-16">
            <div className="bg-white rounded-2xl shadow-lg p-12 max-w-md mx-auto">
              <div className="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <IconCheck className="w-12 h-12 text-[#0A4EC3]" />
              </div>
              <h3 className="text-2xl font-bold text-gray-900 mb-2">Ch∆∞a c√≥ voucher</h3>
              <p className="text-gray-600 mb-6">
                B·∫°n ch∆∞a c√≥ voucher n√†o. H√£y ƒë·∫∑t tour v√† thanh to√°n ƒë·ªÉ nh·∫≠n voucher.
              </p>
              <a
                href="/"
                className="inline-block bg-[#0A4EC3] text-white px-6 py-3 rounded-full font-semibold hover:bg-[#083a9a] transition"
              >
                ƒê·∫∑t tour ngay
              </a>
            </div>
          </div>
        ) : (
          <div className="space-y-8">
            {vouchers.map((voucher, index) => {
              const qrCodeUrl = generateQRCode(voucher.booking_code);
              
  return (
                <div
                  key={index}
                  className="bg-white rounded-3xl shadow-2xl border border-gray-200/50 overflow-hidden relative backdrop-blur-sm"
                  id={`voucher-${index}`}
                  style={{
                    boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
                  }}
                >
                  {/* Seal Background Watermark */}
                  <div 
                    className="absolute inset-0 opacity-[0.03] pointer-events-none z-0"
                    style={{
                      backgroundImage: 'url(/JurniLogo/jurni-seal.png)',
                      backgroundRepeat: 'no-repeat',
                      backgroundPosition: 'center',
                      backgroundSize: '400px 400px'
                    }}
                  />
                  
                  {/* Voucher Content */}
                  <div className="p-10 relative z-10">
                    {/* Header */}
                    <div className="text-center mb-10 pb-8 border-b border-gray-200/60">
                      <div className="mb-5">
                        <img 
                          src="/JurniLogo/apple-touch-icon.png" 
                          alt="Jurni Logo" 
                          className="w-20 h-20 mx-auto object-contain drop-shadow-sm"
                        />
                      </div>
                      <h1 className="text-3xl font-extrabold text-[#0A4EC3] mb-2 uppercase tracking-widest letter-spacing-2">
                        TRAVEL VOUCHER
                      </h1>
                      <p className="text-sm text-gray-500 font-medium tracking-wide">
                        X√°c nh·∫≠n d·ªãch v·ª• ƒë√£ thanh to√°n
                      </p>
                    </div>

                    {/* 3 Columns Info Grid */}
                    <div className="grid md:grid-cols-3 gap-5 mb-8">
                      {/* Th√¥ng tin ƒë·∫∑t tour */}
                      <div className="bg-[#f8fafc] border-2 border-[#0A4EC3] rounded-xl p-5">
                        <h3 className="text-xs uppercase text-gray-600 font-bold mb-4 tracking-widest flex items-center gap-2">
                          <span className="w-1 h-4 bg-[#0A4EC3] rounded-full"></span>
                          Th√¥ng tin ƒë·∫∑t tour
                        </h3>
                        <div className="space-y-3">
                          <div>
                            <div className="text-xs text-gray-500 mb-1.5 font-medium">M√£ ƒë·∫∑t tour</div>
                            <div className="text-base font-bold text-[#0A4EC3] tracking-wide">{voucher.booking_code}</div>
                          </div>
                          <div>
                            <div className="text-xs text-gray-500 mb-1.5 font-medium">Ng√†y ƒë·∫∑t</div>
                            <div className="text-sm font-semibold text-gray-900">{formatDate(voucher.booking_date)}</div>
                          </div>
                          <div>
                            <div className="text-xs text-gray-500 mb-1.5 font-medium">Tr·∫°ng th√°i</div>
                            <div className="inline-flex items-center gap-1.5 bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-full text-xs font-semibold border border-emerald-200">
                              <IconCheck className="w-3 h-3" />
                              {voucher.status}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Th√¥ng tin kh√°ch h√†ng */}
                      <div className="bg-[#f8fafc] border-2 border-[#0A4EC3] rounded-xl p-5">
                        <h3 className="text-xs uppercase text-gray-600 font-bold mb-4 tracking-widest flex items-center gap-2">
                          <span className="w-1 h-4 bg-[#0A4EC3] rounded-full"></span>
                          Th√¥ng tin kh√°ch h√†ng
                        </h3>
                        <div className="space-y-3">
                          <div>
                            <div className="text-xs text-gray-500 mb-1.5 font-medium">H·ªç t√™n</div>
                            <div className="text-sm font-semibold text-gray-900">{voucher.customer?.name || 'N/A'}</div>
                          </div>
                          <div>
                            <div className="text-xs text-gray-500 mb-1.5 font-medium">S·ªë ƒëi·ªán tho·∫°i</div>
                            <div className="text-sm font-semibold text-gray-900">{voucher.customer?.phone || 'N/A'}</div>
                          </div>
                          <div>
                            <div className="text-xs text-gray-500 mb-1.5 font-medium">Email</div>
                            <div className="text-sm font-semibold text-gray-900 break-all">{voucher.customer?.email || 'N/A'}</div>
                          </div>
                        </div>
                      </div>

                      {/* QR Code */}
                      <div className="bg-[#f8fafc] border-2 border-[#0A4EC3] rounded-xl p-5">
                        <h3 className="text-xs uppercase text-gray-600 font-bold mb-4 tracking-widest text-center flex items-center justify-center gap-2">
                          <span className="w-1 h-4 bg-[#0A4EC3] rounded-full"></span>
                          QR Code
                        </h3>
                        <div className="text-center">
                          <div className="inline-block p-3 bg-white border border-gray-200 rounded-xl">
                            <img
                              src={qrCodeUrl}
                              alt="QR Code"
                              className="w-28 h-28"
                            />
                          </div>
                          <p className="text-xs text-gray-500 mt-3 font-medium">
                            Qu√©t m√£ ƒë·ªÉ ki·ªÉm tra t√¨nh tr·∫°ng thanh to√°n
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Chi ti·∫øt d·ªãch v·ª• */}
                    <div className="mb-8">
                      <div className="mb-5">
                        <h2 className="text-xl font-extrabold text-gray-900 mb-1 uppercase tracking-wide">
                          Chi ti·∫øt d·ªãch v·ª•
                        </h2>
                        <div className="w-16 h-0.5 bg-gradient-to-r from-[#0A4EC3] to-transparent"></div>
                      </div>
                      <div className="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                        <table className="w-full border-collapse">
                          <thead>
                            <tr className="bg-gradient-to-r from-[#0A4EC3] via-[#1e5cd8] to-[#2563eb] text-white">
                              <th className="text-left py-4 px-6 text-xs uppercase font-bold tracking-widest border-r border-white/10">Lo·∫°i d·ªãch v·ª•</th>
                              <th className="text-left py-4 px-6 text-xs uppercase font-bold tracking-widest border-r border-white/10">T√™n d·ªãch v·ª•</th>
                              <th className="text-left py-4 px-6 text-xs uppercase font-bold tracking-widest border-r border-white/10">M√¥ t·∫£</th>
                              <th className="text-left py-4 px-6 text-xs uppercase font-bold tracking-widest border-r border-white/10">Th·ªùi gian</th>
                              <th className="text-right py-4 px-6 text-xs uppercase font-bold tracking-widest">Th√†nh ti·ªÅn</th>
                            </tr>
                          </thead>
                          <tbody>
                            {voucher.services?.map((service, idx) => (
                              <tr 
                                key={idx}
                                className={`border-b border-gray-100 transition-all duration-150 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'} hover:bg-blue-50/50`}
                              >
                                <td className="py-4 px-6 border-r border-gray-100">
                                  <div className="text-xs font-semibold text-gray-600 uppercase tracking-wide">{getServiceName(service.type)}</div>
                                </td>
                                <td className="py-4 px-6 border-r border-gray-100">
                                  <div className="text-sm font-bold text-gray-900">{service.name}</div>
                                </td>
                                <td className="py-4 px-6 border-r border-gray-100">
                                  <div className="text-sm text-gray-600 leading-relaxed max-w-xs">{service.description || '-'}</div>
                                </td>
                                <td className="py-4 px-6 border-r border-gray-100">
                                  <div className="text-sm text-gray-700 whitespace-nowrap">
                                    <div className="font-semibold">{formatDate(service.start_date)}</div>
                                    <div className="text-xs text-gray-500 mt-0.5">ƒë·∫øn {formatDate(service.end_date)}</div>
                                  </div>
                                </td>
                                <td className="py-4 px-6 text-right">
                                  <div className="text-sm font-black text-[#0A4EC3] whitespace-nowrap">
                                    {formatPrice(service.price)} VND
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                          <tfoot>
                            <tr className="bg-gray-50 border-t-2 border-gray-300">
                              <td colSpan="4" className="py-5 px-6">
                                <div className="flex flex-col gap-2">
                                  <div className="text-sm font-bold text-gray-900 uppercase tracking-wide">
                                    T·ªïng ti·ªÅn thanh to√°n
                                  </div>
                                  <div className="flex flex-wrap gap-2">
                                    <div className="inline-flex items-center gap-1.5 bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-full text-xs font-semibold border border-emerald-200">
                                      <IconCheck className="w-3 h-3" />
                                      ƒê√£ thanh to√°n
                                    </div>
                                    <div className="inline-flex items-center bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full text-xs font-semibold border border-blue-200">
                                      {voucher.payment_method || 'VNPay'}
                                    </div>
                                  </div>
                                </div>
                              </td>
                              <td className="py-5 px-6 text-right">
                                <div className="text-xl font-black text-[#0A4EC3] whitespace-nowrap">
                                  {formatPrice(voucher.total_price)} VND
                                </div>
                              </td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </div>

                    {/* H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng v√† D·∫•u m·ªôc */}
                    <div className="grid grid-cols-[1fr_auto] gap-6 mb-8">
                      {/* H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng */}
                      <div className="bg-gradient-to-br from-amber-50/80 via-yellow-50/50 to-white border-l-4 border-amber-400 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                        <h3 className="text-sm font-extrabold text-amber-900 mb-5 uppercase tracking-widest flex items-center gap-2">
                          <span className="w-1.5 h-5 bg-amber-400 rounded-full"></span>
                          H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG VOUCHER
                        </h3>
                        <ul className="space-y-3.5">
                          <li className="flex items-start gap-3.5 text-sm text-amber-900 leading-relaxed">
                            <span className="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 text-emerald-600 font-bold text-xs shadow-sm">
                              ‚úì
                            </span>
                            <span className="font-medium">Check-in s√¢n bay b·∫±ng QR ho·∫∑c m√£ tour</span>
                          </li>
                          <li className="flex items-start gap-3.5 text-sm text-amber-900 leading-relaxed">
                            <span className="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 text-emerald-600 font-bold text-xs shadow-sm">
                              ‚úì
                            </span>
                            <span className="font-medium">Nh·∫≠n ph√≤ng c·∫ßn voucher + CCCD</span>
                          </li>
                          <li className="flex items-start gap-3.5 text-sm text-amber-900 leading-relaxed">
                            <span className="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 text-emerald-600 font-bold text-xs shadow-sm">
                              ‚úì
                            </span>
                            <span className="font-medium">Nh·∫≠n xe c·∫ßn ƒë·ªëi chi·∫øu th√¥ng tin</span>
                          </li>
                          <li className="flex items-start gap-3.5 text-sm text-amber-900 leading-relaxed">
                            <span className="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 text-emerald-600 font-bold text-xs shadow-sm">
                              ‚úì
                            </span>
                            <span className="font-medium">Tham gia tour tr√¨nh voucher cho HDV</span>
                          </li>
                        </ul>
                      </div>
                      
                      {/* D·∫•u m·ªôc */}
                      <div className="flex flex-col items-center justify-center">
                        <div className="w-40 h-40 flex items-center justify-center">
                          <img 
                            src="/JurniLogo/jurni-seal.png" 
                            alt="Jurni Seal" 
                            className="w-full h-full object-contain"
                            onError={(e) => {
                              e.target.style.display = 'none';
                              e.target.parentElement.innerHTML = '<div class="flex flex-col items-center justify-center p-3"><div class="text-[8px] font-bold text-[#0A4EC3] uppercase tracking-wider mb-1">VERIFIED & APPROVED</div><div class="text-2xl font-black text-[#0A4EC3] mb-1">JURNI</div><div class="text-[7px] font-semibold text-[#0A4EC3] mb-1">TRAVEL</div><div class="text-[6px] font-medium text-[#0A4EC3]">EST. 2025</div><div class="text-[6px] font-bold text-[#0A4EC3] uppercase tracking-widest mt-1">OFFICIAL AUTHENTICATION SEAL</div></div>';
                            }}
                          />
                        </div>
                        <div className="mt-3 text-xs text-gray-600 italic font-medium">
                          Ch·ª©ng nh·∫≠n b·ªüi JURNI
                        </div>
                      </div>
                    </div>


                    {/* Footer */}
                    <div className="text-center pt-8 border-t border-gray-200/60">
                      <div className="text-2xl font-extrabold text-[#0A4EC3] mb-4 uppercase tracking-widest">
                        JURNI TRAVEL
                      </div>
                      <div className="mb-3 text-sm text-gray-600 font-medium">
                        Ph√¢n khu E1, Khu c√¥ng ngh·ªá cao, Xa l·ªô H√† N·ªôi, Ph∆∞·ªùng Hi·ªáp Ph√∫, TP. Th·ªß ƒê·ª©c, TP.HCM
                      </div>
                      <div className="mb-5 text-sm text-gray-600 font-medium">
                        <span className="font-semibold">Hotline:</span> 0769 749 465 | <span className="font-semibold">Email:</span> support@jurni.com
                      </div>
                      <div className="text-xs text-gray-400 italic font-medium bg-gray-50/50 py-2 px-4 rounded-lg inline-block">
                        Voucher n√†y l√† t√†i li·ªáu ch√≠nh th·ª©c x√°c nh·∫≠n vi·ªác ƒë·∫∑t v√† thanh to√°n d·ªãch v·ª• du l·ªãch.
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="mt-10 flex flex-wrap gap-4 pt-8 border-t border-gray-200/60">
                      <button
                        onClick={() => handlePrint(voucher)}
                        className="flex-1 bg-white border-2 border-[#0A4EC3] text-[#0A4EC3] hover:bg-[#0A4EC3] hover:text-white px-8 py-3.5 rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2.5 shadow-sm hover:shadow-md"
                      >
                        <IconPrint className="w-5 h-5" />
                        In voucher
                      </button>
                      <button
                        onClick={() => handleDownload(voucher)}
                        className="flex-1 bg-gradient-to-r from-[#0A4EC3] to-[#2563eb] hover:from-[#083a9a] hover:to-[#1e5cd8] text-white px-8 py-3.5 rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2.5 shadow-md hover:shadow-lg"
                      >
                        <IconDownload className="w-5 h-5" />
                        T·∫£i xu·ªëng JPG
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}
